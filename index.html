<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGNITE 2025 | Ticket Verifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Bebas+Neue&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #111827;
            --bg-light: #1F2937;
            --primary-red: #EF4444;
            --text-primary: #F9FAFB;
            --text-secondary: #D1D5DB;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            overflow-y: auto;
            color: var(--text-secondary); /* Default text color */
        }

        #scanner-container { position: relative; width: 100%; padding-top: 100%; overflow: hidden; border-radius: 1.5rem; }
        #scanner-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        #viewfinder { position: absolute; top: 10%; left: 10%; width: 80%; height: 80%; box-shadow: 0 0 0 400px rgba(17, 24, 39, 0.7); border: 2px solid rgba(255, 255, 255, 0.8); border-radius: 1rem; }
        #viewfinder::before, #viewfinder::after { content: ''; position: absolute; width: 40px; height: 40px; }
        #viewfinder::before { top: -2px; left: -2px; border-top: 4px solid var(--primary-red); border-left: 4px solid var(--primary-red); border-radius: 1rem 0 0 0; }
        #viewfinder::after { top: -2px; right: -2px; border-top: 4px solid var(--primary-red); border-right: 4px solid var(--primary-red); border-radius: 0 1rem 0 0; }
        .viewfinder-bottom::before, .viewfinder-bottom::after { content: ''; position: absolute; width: 40px; height: 40px; }
        .viewfinder-bottom::before { bottom: -2px; left: -2px; border-bottom: 4px solid var(--primary-red); border-left: 4px solid var(--primary-red); border-radius: 0 0 0 1rem; }
        .viewfinder-bottom::after { bottom: -2px; right: -2px; border-bottom: 4px solid var(--primary-red); border-right: 4px solid var(--primary-red); border-radius: 0 0 1rem 0; }
        
        .scan-line { 
            position: absolute; top: 0; left: 5%; width: 90%; height: 3px; 
            background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.8), transparent);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.7);
            border-radius: 3px; 
            animation: scan 2.5s infinite ease-in-out; 
        }
        @keyframes scan { 
            0% { transform: translateY(10px); } 
            50% { transform: translateY(calc(100% - 10px)); } 
            100% { transform: translateY(10px); } 
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .modal-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes slideDownIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .log-entry-animation { animation: slideDownIn 0.4s ease-out forwards; }

        .log-list::-webkit-scrollbar { width: 8px; }
        .log-list::-webkit-scrollbar-track { background: var(--bg-dark); border-radius: 10px; }
        .log-list::-webkit-scrollbar-thumb { background: var(--primary-red); border-radius: 10px; }
        .log-list::-webkit-scrollbar-thumb:hover { background: #d03030; }
    </style>
</head>
<body class="h-full flex flex-col items-center justify-start p-4 md:py-8">

    <div class="w-full max-w-md mx-auto">
        <div class="bg-bg-light rounded-2xl shadow-2xl overflow-hidden text-center p-6 md:p-8">
            <h1 class="text-5xl font-bold text-red-500" style="font-family: 'Bebas Neue', cursive;">Ticket Verifier</h1>
            <p class="text-text-secondary mt-2 mb-6">For IGNITE 2025 ðŸ”¥</p>
            <div id="scanner-container" class="bg-black">
                <video id="scanner-video" playsinline></video>
                <div id="viewfinder"><div class="viewfinder-bottom"></div><div class="scan-line"></div></div>
            </div>
            <canvas id="scanner-canvas" class="hidden"></canvas>
            <p id="scan-status-message" class="mt-4 font-medium text-text-primary">Requesting camera access...</p>
            <div class="my-6 flex items-center"><hr class="flex-grow border-t border-gray-700"><span class="px-3 text-gray-400 text-sm font-semibold">OR</span><hr class="flex-grow border-t border-gray-700"></div>
            <label for="file-input" class="w-full cursor-pointer bg-gray-700 text-text-primary font-bold py-3 px-4 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-red-500/50 transition-all transform hover:scale-105 shadow-lg flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                <span>Scan From Photo</span>
            </label>
            <input type="file" id="file-input" accept="image/*" class="hidden">
        </div>

        <div class="bg-bg-light rounded-2xl shadow-2xl text-left p-6 md:p-8 mt-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Verification Log</h2>
                <div class="text-right">
                    <p class="font-semibold text-gray-300">Checked-In</p>
                    <p class="text-3xl font-bold text-red-500" id="log-count">0</p>
                </div>
            </div>
            <div id="log-list" class="log-list max-h-64 overflow-y-auto pr-2 space-y-3">
                <p id="log-placeholder" class="text-center text-gray-400 py-8">No attendees verified yet.</p>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-700">
                <button id="clear-log-btn" class="w-full text-sm bg-red-800/50 text-red-300 font-bold py-2 px-4 rounded-lg hover:bg-red-800 hover:text-red-200 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Clear Selected (0)
                </button>
            </div>
        </div>
    </div>

    <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-bg-light rounded-2xl shadow-xl max-w-sm w-full p-8 text-center modal-fade-in border border-gray-700">
              <div id="result-icon"></div>
              <h3 id="result-title" class="text-2xl font-bold mt-4"></h3>
              <div id="attendee-details" class="mt-4 text-left space-y-2 hidden">
                  <div><p class="text-sm font-medium text-gray-400">Name</p><p id="attendee-name" class="text-xl font-semibold text-white"></p></div>
                  <div><p class="text-sm font-medium text-gray-400">Email</p><p id="attendee-email" class="text-lg text-gray-300"></p></div>
                  <div><p class="text-sm font-medium text-gray-400">Ticket ID</p><p id="attendee-id" class="text-sm text-gray-500 font-mono"></p></div>
                  <div id="scan-time-wrapper" class="hidden pt-2 mt-2 border-t border-gray-700"><p class="text-sm font-medium text-gray-400">Original Scan Time</p><p id="scan-time" class="text-lg text-gray-300"></p></div>
              </div>
              <button id="modal-close-btn" class="mt-8 bg-red-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-bg-light focus:ring-red-500 w-full">Scan Next Ticket</button>
        </div>
    </div>

    <div id="password-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-bg-dark/95 backdrop-blur-sm hidden">
        <div class="w-full max-w-xs p-8 space-y-6 rounded-lg shadow-2xl bg-bg-light">
            <h2 class="text-2xl font-bold text-center text-text-primary">Confirm Action</h2>
            <p class="text-center text-sm text-text-secondary">Enter the admin password to clear the selected log entries. This cannot be undone.</p>
            <form id="password-form">
                <div class="space-y-4">
                    <div>
                        <label for="clear-password" class="sr-only">Password</label>
                        <input id="clear-password" type="password" required class="w-full px-4 py-2 text-white transition duration-200 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-red" placeholder="Enter Password">
                    </div>
                    <p id="password-error-message" class="text-sm text-center text-red-500 hidden">Incorrect Password.</p>
                    <div class="flex gap-4">
                        <button type="button" id="cancel-clear-btn" class="w-full px-4 py-2 font-bold text-gray-300 transition-colors duration-200 bg-gray-600 rounded-md hover:bg-gray-500">
                            Cancel
                        </button>
                        <button type="submit" class="w-full px-4 py-2 font-bold text-white transition-colors duration-200 rounded-md bg-primary-red hover:bg-red-600">
                            Confirm
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, serverTimestamp, collection, query, where, onSnapshot, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAPd9loQiNnouyKtxfwv-s7jcPzpZKmhys",
            authDomain: "ignite-event-2025-nagpur.firebaseapp.com",
            projectId: "ignite-event-2025-nagpur",
            storageBucket: "ignite-event-2025-nagpur.appspot.com",
            messagingSenderId: "480552824914",
            appId: "1:480552824914:web:d67e8c9f208c67ac7fef8b",
            measurementId: "G-RLPWDK8MR2"
        };
        
        let db;
        let stream = null;
        const checkedInAttendees = {};

        // UI Elements
        const video = document.getElementById('scanner-video');
        const canvasElement = document.getElementById('scanner-canvas');
        const canvas = canvasElement.getContext('2d', { willReadFrequently: true });
        const scanStatusMessage = document.getElementById('scan-status-message');
        const fileInput = document.getElementById('file-input');
        const resultModal = document.getElementById('result-modal');
        const resultIcon = document.getElementById('result-icon');
        const resultTitle = document.getElementById('result-title');
        const attendeeDetails = document.getElementById('attendee-details');
        const attendeeName = document.getElementById('attendee-name');
        const attendeeEmail = document.getElementById('attendee-email');
        const attendeeId = document.getElementById('attendee-id');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const scanTimeWrapper = document.getElementById('scan-time-wrapper');
        const scanTime = document.getElementById('scan-time');
        const logCount = document.getElementById('log-count');
        const logList = document.getElementById('log-list');
        const logPlaceholder = document.getElementById('log-placeholder');
        
        const clearLogBtn = document.getElementById('clear-log-btn');
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');
        const cancelClearBtn = document.getElementById('cancel-clear-btn');
        const passwordError = document.getElementById('password-error-message');


        function stopScanner() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            video.pause();
            video.srcObject = null;
            stream = null;
        }

        async function startScanner() {
            try {
                stopScanner();
                scanStatusMessage.textContent = "Initializing camera...";
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    scanStatusMessage.textContent = "Point camera at a QR code";
                    requestAnimationFrame(tick);
                };
            } catch (err) {
                console.error("Camera Error:", err);
                scanStatusMessage.textContent = "Camera access denied.";
            }
        }
        
        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
                if (code) {
                    handleQrCode(code.data);
                    return;
                }
            }
            if (stream && stream.active) {
                requestAnimationFrame(tick);
            }
        }

        async function handleQrCode(data) {
            stopScanner();
            scanStatusMessage.textContent = "QR Code Detected! Verifying...";
            
            try {
                const ticketData = JSON.parse(data);
                if (!ticketData.id) {
                    showResult('error', 'Invalid QR Format', null);
                    return;
                }

                const processDoc = async (docSnap, collectionName) => {
                    const attendee = docSnap.data();
                    const displayData = { ...attendee, id: docSnap.id };

                    if (attendee.checkedIn) {
                        showResult('warning', 'Already Checked In', displayData);
                    } else {
                        const docRefToUpdate = doc(db, collectionName, docSnap.id);
                        await updateDoc(docRefToUpdate, {
                            checkedIn: true,
                            checkedInAt: serverTimestamp()
                        });

                        // **FIX: Manually update local state for instant log update**
                        const updatedAttendeeData = { 
                            id: docSnap.id, 
                            ...attendee, 
                            checkedIn: true, 
                            checkedInAt: { toDate: () => new Date() }, // Use client-side date as a placeholder
                            sourceCollection: collectionName
                        };
                        checkedInAttendees[docSnap.id] = updatedAttendeeData;
                        renderCombinedLog(); // Force re-render of the log
                        
                        showResult('success', 'Access Granted', displayData);
                    }
                };

                let docRef = doc(db, 'attendees', ticketData.id);
                let docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    await processDoc(docSnap, 'attendees');
                    return;
                }

                docRef = doc(db, 'attendees_cash', ticketData.id);
                docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    await processDoc(docSnap, 'attendees_cash');
                    return;
                }

                showResult('error', 'Invalid Ticket', { name: ticketData.name || "Unknown", email: ticketData.email || "N/A", id: 'NOT FOUND' });

            } catch (error) {
                console.error("Verification error:", error);
                showResult('error', 'Invalid QR Code', null);
            }
        }

        fileInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = event => {
                const img = new Image();
                img.onload = () => {
                    canvasElement.width = img.width;
                    canvasElement.height = img.height;
                    canvas.drawImage(img, 0, 0, img.width, img.height);
                    const imageData = canvas.getImageData(0, 0, img.width, img.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    if (code) handleQrCode(code.data);
                    else showResult('error', 'No QR Code Found', null);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        function showResult(type, title, data) {
            resultTitle.textContent = title;
            attendeeDetails.classList.add('hidden');
            scanTimeWrapper.classList.add('hidden');
            
            const resultClasses = {
                success: 'text-green-400',
                error: 'text-red-500',
                warning: 'text-orange-400'
            };
            resultTitle.className = `text-2xl font-bold mt-4 ${resultClasses[type]}`;

            const icons = {
                success: `<svg class="w-20 h-20 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                error: `<svg class="w-20 h-20 mx-auto text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                warning: `<svg class="w-20 h-20 mx-auto text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`
            };
            resultIcon.innerHTML = icons[type];
            
            if (data) {
                attendeeName.textContent = data.name;
                attendeeEmail.textContent = data.email;
                attendeeId.textContent = data.id;
                attendeeDetails.classList.remove('hidden');
                if (type === 'warning' && data.checkedInAt) {
                    scanTime.textContent = data.checkedInAt.toDate().toLocaleString();
                    scanTimeWrapper.classList.remove('hidden');
                }
            }
            resultModal.classList.remove('hidden');
        }

        modalCloseBtn.addEventListener('click', () => {
            resultModal.classList.add('hidden');
            fileInput.value = '';
            startScanner();
        });

        async function initializeFirebase() {
              try {
                  const app = initializeApp(firebaseConfig);
                  db = getFirestore(app);
                  await signInAnonymously(getAuth(app)); 
                  console.log("Firebase Verifier Initialized.");
                  setupLogListeners();
              } catch (error) {
                  console.error("Error initializing Firebase:", error);
                  scanStatusMessage.textContent = "Database connection failed.";
              }
        }
        
        function renderCombinedLog() {
            const checkIns = Object.values(checkedInAttendees);
            logCount.textContent = checkIns.length;
            
            if (checkIns.length === 0) {
                logList.innerHTML = '';
                logList.appendChild(logPlaceholder);
                logPlaceholder.classList.remove('hidden');
                return;
            }
            
            logPlaceholder.classList.add('hidden');
            logList.innerHTML = '';

            checkIns.sort((a, b) => (b.checkedInAt?.toDate() || 0) - (a.checkedInAt?.toDate() || 0));

            checkIns.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'log-entry-animation p-3 bg-gray-700/50 rounded-lg flex items-center space-x-3 border border-gray-700';
                const icon = `<svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                
                entryDiv.innerHTML = `
                    <div class="flex-shrink-0">
                        <input type="checkbox" class="log-checkbox h-5 w-5 rounded bg-gray-600 border-gray-500 text-red-500 focus:ring-red-500/50" data-id="${entry.id}" data-collection="${entry.sourceCollection}">
                    </div>
                    <div class="flex-shrink-0">${icon}</div>
                    <div class="flex-grow min-w-0">
                        <p class="font-semibold text-white truncate">${entry.name}</p>
                        <p class="text-xs text-gray-400 truncate">ID: ${entry.id.substring(0,8)}...</p>
                    </div>
                    <div class="text-right text-sm text-gray-400 flex-shrink-0">
                        ${entry.checkedInAt ? entry.checkedInAt.toDate().toLocaleTimeString() : ''}
                    </div>`;
                logList.appendChild(entryDiv);
            });
        }
        
        function setupLogListeners() {
            const handleError = (error, collectionName) => {
                console.error(`Firestore listener error on ${collectionName}:`, error);
                logList.innerHTML = `<p class="text-center text-red-400 py-8">Error loading log. Check permissions.</p>`;
            };

            const q1 = query(collection(db, 'attendees'), where('checkedIn', '==', true));
            onSnapshot(q1, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const docData = { id: change.doc.id, ...change.doc.data(), sourceCollection: 'attendees' };
                    if (change.type === "added" || change.type === "modified") {
                        checkedInAttendees[change.doc.id] = docData;
                    } else if (change.type === "removed") {
                        delete checkedInAttendees[change.doc.id];
                    }
                });
                renderCombinedLog();
            }, (error) => handleError(error, 'attendees'));

            const q2 = query(collection(db, 'attendees_cash'), where('checkedIn', '==', true));
            onSnapshot(q2, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                     const docData = { id: change.doc.id, ...change.doc.data(), sourceCollection: 'attendees_cash' };
                    if (change.type === "added" || change.type === "modified") {
                        checkedInAttendees[change.doc.id] = docData;
                    } else if (change.type === "removed") {
                        delete checkedInAttendees[change.doc.id];
                    }
                });
                renderCombinedLog();
            }, (error) => handleError(error, 'attendees_cash'));
        }

        async function clearSelectedLogs() {
            const selectedLogs = document.querySelectorAll('.log-checkbox:checked');
            if (selectedLogs.length === 0) {
                alert("No logs selected to clear.");
                return;
            }

            try {
                const batch = writeBatch(db);
                selectedLogs.forEach(checkbox => {
                    const docRef = doc(db, checkbox.dataset.collection, checkbox.dataset.id);
                    batch.update(docRef, { checkedIn: false, checkedInAt: null });
                });
                
                await batch.commit();
                
                // Firestore listener will handle the UI update automatically
                alert(`Success! ${selectedLogs.length} log(s) have been cleared.`);
            } catch (error) {
                console.error("Error clearing log:", error);
                alert(`Error: Could not clear the selected logs. ${error.message}`);
            }
        }

        function updateClearButtonCount() {
            const selectedCount = document.querySelectorAll('.log-checkbox:checked').length;
            clearLogBtn.textContent = `Clear Selected (${selectedCount})`;
            clearLogBtn.disabled = selectedCount === 0;
        }

        logList.addEventListener('change', (e) => {
            if (e.target.classList.contains('log-checkbox')) {
                updateClearButtonCount();
            }
        });

        clearLogBtn.addEventListener('click', () => {
            const selectedCount = document.querySelectorAll('.log-checkbox:checked').length;
            if(selectedCount > 0) {
                passwordModal.classList.remove('hidden');
            } else {
                alert("Please select at least one log entry to clear.");
            }
        });

        cancelClearBtn.addEventListener('click', () => {
            passwordModal.classList.add('hidden');
            passwordForm.reset();
            passwordError.classList.add('hidden');
        });

        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = e.target['clear-password'].value;
            const CORRECT_CLEAR_PASSWORD = "igniteclear2025";

            if (password === CORRECT_CLEAR_PASSWORD) {
                await clearSelectedLogs();
                passwordModal.classList.add('hidden');
                passwordForm.reset();
                passwordError.classList.add('hidden');
            } else {
                passwordError.classList.remove('hidden');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            startScanner();
        });
    </script>
</body>
</html>
